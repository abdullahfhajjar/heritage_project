{% load static i18n socialaccount nav_helpers %}
{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}{% trans "Turath3D" %}{% endblock %}</title>

  <!-- Fonts (Arabic + Latin) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Kufi+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <!-- Tailwind (CDN) + brand theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              navy: "#8B3A2B",
              gold: "#C9A66B",
              sand: "#F5E9DA",
              charcoal: "#1A1A1A",
              palm: "#2D5A27",
              mist: "#EFF3F6"
            }
          },
          fontFamily: {
            sans: ["Inter","system-ui","-apple-system","Segoe UI","Roboto","Ubuntu","Noto Sans","sans-serif"],
            arabic: ["Noto Kufi Arabic","Inter","sans-serif"]
          },
          boxShadow: {
            soft: "0 8px 24px rgba(10,31,68,0.08)"
          },
          borderRadius: {
            xl2: "1rem"
          }
        }
      }
    }
  </script>

  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    :root { color-scheme: light; }
    body { font-family: {% if LANGUAGE_CODE == 'ar' %}theme('fontFamily.arabic'){% else %}theme('fontFamily.sans'){% endif %}; }

    /* tiny flag styling so they look crisp everywhere */
    .flag { display:inline-flex; width: 18px; height: 12px; border-radius: 2px; overflow: hidden; box-shadow: 0 0 0 1px rgba(0,0,0,.08) inset; }
    .flag svg { width: 100%; height: 100%; display:block; }
  </style>
</head>

<body class="min-h-screen bg-brand-mist"
      dir="{% if LANGUAGE_CODE == 'ar' %}rtl{% else %}ltr{% endif %}">

  <!-- Top bar / Navigation -->
  <header class="bg-brand-navy text-white shadow-soft">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <!-- Logo + title -->
      <a href="/" class="flex items-center gap-3 group relative">
        <img src="{% static 'images/logo.png' %}" alt="{% trans 'Turath3D logo' %}" 
             class="h-12 w-auto transition-transform duration-300 group-hover:scale-105" />
        <span class="text-lg sm:text-xl font-semibold tracking-wide relative">
          {% trans "Turath3D" %}
          <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-brand-gold transition-all duration-300 group-hover:w-full"></span>
          <span class="absolute -bottom-2 left-0 w-full h-px border-b border-dotted border-brand-gold/40 scale-x-0 transition-transform duration-300 group-hover:scale-x-100"></span>
        </span>
      </a>

      <!-- Nav + actions -->
      <div class="flex items-center gap-4 sm:gap-6 text-sm">

        <!-- Main nav -->
        <nav class="hidden md:flex items-center gap-6">
          <a href="/"
             class="relative transition-colors
               {% if request.path == '/' %}text-brand-gold{% else %}text-white/85 hover:text-brand-gold{% endif %}">
            {% trans "Home" %}
            <span class="{% if request.path == '/' %}block{% else %}hidden{% endif %} absolute -bottom-2 left-0 right-0 h-[2px] bg-brand-gold"></span>
          </a>
          {% is_heritage_page request.path as is_heritage %}
          <a href="/heritage/"
             class="relative transition-colors
               {% if is_heritage %}text-brand-gold{% else %}text-white/85 hover:text-brand-gold{% endif %}">
            {% trans "Collections" %}
            <span class="{% if is_heritage %}block{% else %}hidden{% endif %} absolute -bottom-2 left-0 right-0 h-[2px] bg-brand-gold"></span>
          </a>
          <a href="/about/"
             class="relative transition-colors
               {% if request.path == '/about/' %}text-brand-gold{% else %}text-white/85 hover:text-brand-gold{% endif %}">
            {% trans "About" %}
            <span class="{% if request.path == '/about/' %}block{% else %}hidden{% endif %} absolute -bottom-2 left-0 right-0 h-[2px] bg-brand-gold"></span>
          </a>
          <a href="/sponsors/"
             class="relative transition-colors
               {% if request.path == '/sponsors/' %}text-brand-gold{% else %}text-white/85 hover:text-brand-gold{% endif %}">
            {% trans "Sponsors" %}
            <span class="{% if request.path == '/sponsors/' %}block{% else %}hidden{% endif %} absolute -bottom-2 left-0 right-0 h-[2px] bg-brand-gold"></span>
          </a>
          <a href="/donate/"
             class="relative transition-colors
               {% if request.path == '/donate/' %}text-brand-gold{% else %}text-white/85 hover:text-brand-gold{% endif %}">
            {% trans "Donate" %}
            <span class="{% if request.path == '/donate/' %}block{% else %}hidden{% endif %} absolute -bottom-2 left-0 right-0 h-[2px] bg-brand-gold"></span>
          </a>
        </nav>

        <!-- Language switcher -->
        <div x-data="{ open:false }" class="relative">
          <!-- Hidden form to post to set_language and keep the current page -->
          <form x-ref="form" action="{% url 'set_language' %}" method="post" class="hidden">
            {% csrf_token %}
            <input type="hidden" name="language" x-ref="langValue">
            <input type="hidden" name="next" value="{{ request.get_full_path|default:'/' }}">
          </form>

          <!-- Trigger button -->
          <button type="button"
                  @click="open = !open"
                  class="flex items-center bg-white/10 text-white border border-white/20 rounded-md px-3 py-1.5
                         focus:outline-none focus:ring-2 focus:ring-brand-gold/60 hover:bg-white/15">
            {% if LANGUAGE_CODE == 'ar' %}
              <!-- SA flag LEFT, then Arabic text -->
              <span class="flex items-center">
                <span class="flag ml-1" aria-label="{% trans 'Saudi Arabia' %}">
                  <svg viewBox="0 0 28 20" xmlns="http://www.w3.org/2000/svg">
                    <rect width="28" height="20" fill="#006C35"/>
                    <rect x="4" y="6" width="20" height="2" fill="#ffffff" opacity=".85"/>
                    <rect x="8" y="12" width="12" height="2" fill="#ffffff" opacity=".85"/>
                  </svg>
                </span>
                <span class="text-sm">العربية</span>
              </span>
            {% elif LANGUAGE_CODE == 'fr' %}
              <!-- French text then French flag -->
              <span class="flex items-center">
                <span class="text-sm">Français</span>
                <span class="flag ml-1" aria-label="{% trans 'France' %}">
                  <svg viewBox="0 0 28 20" xmlns="http://www.w3.org/2000/svg">
                    <rect width="28" height="20" fill="#002654"/>
                    <rect x="0" width="9.33" height="20" fill="#002654"/>
                    <rect x="9.33" width="9.34" height="20" fill="#ffffff"/>
                    <rect x="18.67" width="9.33" height="20" fill="#CE1126"/>
                  </svg>
                </span>
              </span>
            {% else %}
              <!-- English text then GB flag -->
              <span class="flex items-center">
                <span class="text-sm">English</span>
                <span class="flag ml-1" aria-label="{% trans 'United Kingdom' %}">
                  <svg viewBox="0 0 28 20" xmlns="http://www.w3.org/2000/svg">
                    <rect width="28" height="20" fill="#012169"/>
                    <path d="M0,0 L28,20 M28,0 L0,20" stroke="#fff" stroke-width="4"/>
                    <path d="M0,0 L28,20 M28,0 L0,20" stroke="#C8102E" stroke-width="2"/>
                    <rect x="11" width="6" height="20" fill="#fff"/>
                    <rect y="7" width="28" height="6" fill="#fff"/>
                    <rect x="12" width="4" height="20" fill="#C8102E"/>
                    <rect y="8" width="28" height="4" fill="#C8102E"/>
                  </svg>
                </span>
              </span>
            {% endif %}
            <svg :class="{'rotate-180': open}" class="w-4 h-4 opacity-90 {% if LANGUAGE_CODE == 'ar' %}mr-2{% else %}ml-2{% endif %} transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>

          <!-- Menu -->
          <div x-show="open" @click.outside="open=false" x-transition
               class="absolute {% if LANGUAGE_CODE == 'ar' %}left-0{% else %}right-0{% endif %} mt-2 w-44 bg-white border border-brand-navy/15 rounded-md shadow-soft overflow-hidden z-30">
            <!-- English -->
            <button type="button"
                    @click="$refs.langValue.value='en'; $refs.form.submit()"
                    class="w-full flex items-center px-3 py-2 text-sm hover:bg-brand-sand text-brand-navy">
              <span>English</span>
              <span class="flag {% if LANGUAGE_CODE == 'ar' %}mr-2{% else %}ml-2{% endif %}" aria-hidden="true">
                <svg viewBox="0 0 28 20" xmlns="http://www.w3.org/2000/svg">
                  <rect width="28" height="20" fill="#012169"/>
                  <path d="M0,0 L28,20 M28,0 L0,20" stroke="#fff" stroke-width="4"/>
                  <path d="M0,0 L28,20 M28,0 L0,20" stroke="#C8102E" stroke-width="2"/>
                  <rect x="11" width="6" height="20" fill="#fff"/>
                  <rect y="7" width="28" height="6" fill="#fff"/>
                  <rect x="12" width="4" height="20" fill="#C8102E"/>
                  <rect y="8" width="28" height="4" fill="#C8102E"/>
                </svg>
              </span>
            </button>
            <!-- Arabic -->
            <button type="button"
                    @click="$refs.langValue.value='ar'; $refs.form.submit()"
                    class="w-full flex items-center px-3 py-2 text-sm hover:bg-brand-sand text-brand-navy">
              <span class="flag {% if LANGUAGE_CODE == 'ar' %}ml-2{% else %}mr-2{% endif %}" aria-hidden="true">
                <svg viewBox="0 0 28 20" xmlns="http://www.w3.org/2000/svg">
                  <rect width="28" height="20" fill="#006C35"/>
                  <rect x="4" y="6" width="20" height="2" fill="#ffffff" opacity=".85"/>
                  <rect x="8" y="12" width="12" height="2" fill="#ffffff" opacity=".85"/>
                </svg>
              </span>
              <span class="text-brand-navy">العربية</span>
            </button>
            <!-- French -->
            <button type="button"
                    @click="$refs.langValue.value='fr'; $refs.form.submit()"
                    class="w-full flex items-center px-3 py-2 text-sm hover:bg-brand-sand text-brand-navy">
              <span>Français</span>
              <span class="flag {% if LANGUAGE_CODE == 'ar' %}mr-2{% else %}ml-2{% endif %}" aria-hidden="true">
                <svg viewBox="0 0 28 20" xmlns="http://www.w3.org/2000/svg">
                  <rect width="28" height="20" fill="#002654"/>
                  <rect x="0" width="9.33" height="20" fill="#002654"/>
                  <rect x="9.33" width="9.34" height="20" fill="#ffffff"/>
                  <rect x="18.67" width="9.33" height="20" fill="#CE1126"/>
                </svg>
              </span>
            </button>
          </div>
        </div>

        <!-- Auth: Google Sign-in (logged out) / Account dropdown (logged in) -->
        {% if user.is_authenticated %}
          <div x-data="{ open:false }" class="relative">
            <button @click="open = !open"
                    class="flex items-center bg-white/10 text-white border border-white/20 rounded-md px-2.5 py-1.5 hover:bg-white/15 focus:outline-none focus:ring-2 focus:ring-brand-gold/60">
              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-white/20 text-white font-semibold text-xs">
                {{ user.first_name|default:user.username|first|upper }}
              </span>
              <svg :class="{'rotate-180': open}" class="w-4 h-4 opacity-90 {% if LANGUAGE_CODE == 'ar' %}mr-2{% else %}ml-2{% endif %} transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </button>

            <div x-show="open" @click.outside="open=false" x-transition
                 class="absolute {% if LANGUAGE_CODE == 'ar' %}left-0{% else %}right-0{% endif %} mt-2 w-56 bg-white border border-brand-navy/15 rounded-md shadow-soft overflow-hidden z-30">
              <!-- Primary links -->
              <a href="{% url 'me-dashboard' %}" class="block px-3 py-2 text-sm text-brand-navy hover:bg-brand-sand">{% trans "My dashboard" %}</a>
              <a href="{% url 'public-profile' user.username %}" class="block px-3 py-2 text-sm text-brand-navy hover:bg-brand-sand">{% trans "Public profile" %}</a>
              <a href="{% url 'my-submissions' %}" class="block px-3 py-2 text-sm text-brand-navy hover:bg-brand-sand">{% trans "My submissions" %}</a>
              <a href="{% url 'my-proposals' %}" class="block px-3 py-2 text-sm text-brand-navy hover:bg-brand-sand">{% trans "My proposals" %}</a>
              <a href="{% url 'submit-object' %}" class="block px-3 py-2 text-sm text-brand-navy hover:bg-brand-sand">{% trans "Submit new object" %}</a>

              <div class="h-px bg-brand-navy/10 my-1"></div>

              <!-- Sign out (POST) -->
              <form method="post" action="{% url 'account_logout' %}">
                {% csrf_token %}
                <button type="submit" class="w-full text-left px-3 py-2 text-sm text-brand-navy hover:bg-brand-sand">
                  {% trans "Sign out" %}
                </button>
              </form>
            </div>
          </div>
        {% else %}
          <a href="{% provider_login_url 'google' next=request.get_full_path %}"
             class="inline-flex items-center rounded-md bg-white text-brand-navy font-semibold px-3 py-1.5 shadow-soft hover:bg-white/95 focus:outline-none focus:ring-2 focus:ring-brand-gold/60 border border-white/20">
            <!-- Google "G" icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"
                 class="w-4 h-4 {% if LANGUAGE_CODE == 'ar' %}ml-2{% else %}mr-2{% endif %}">
              <path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.8 32.7 29.4 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.9 1.2 8 3.1l5.7-5.7C34.6 6.1 29.6 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20 20-8.9 20-20c0-1.3-.1-2.7-.4-3.5z"/>
              <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.7 16 19 12 24 12c3.1 0 5.9 1.2 8 3.1l5.7-5.7C34.6 6.1 29.6 4 24 4c-7.7 0-14.3 4.3-17.7 10.7z"/>
              <path fill="#4CAF50" d="M24 44c5.3 0 10.1-2 13.7-5.3l-6.3-5.2C29.3 35.9 26.8 37 24 37c-5.3 0-9.8-3.4-11.4-8.1l-6.6 5.1C9.4 39.6 16.1 44 24 44z"/>
              <path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.3 3.7-4.7 6.5-8.3 6.5-2.5 0-4.7-1-6.3-2.6l-6.6 5.1C16.2 41.6 19.9 44 24 44c8 0 14.8-5.4 17.2-12.7.9-2.5 1.4-5.2 1.4-8.3 0-1.3-.1-2.7-.4-3.5z"/>
            </svg>
            {% trans "Sign in" %}
          </a>
        {% endif %}

        <!-- Search -->
        <div x-data="{ open: false }" class="relative" @click.outside="open=false" @keydown.escape.window="open=false">
          <button type="button"
                  @click="open = !open; if(open) $nextTick(()=> $refs.q.focus())"
                  class="p-2 rounded-md hover:bg-white/10 text-brand-gold transition-all duration-200 hover:scale-110 group">
            <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 104.5 4.5a7.5 7.5 0 0012.15 12.15z"/>
            </svg>
          </button>
          <div x-show="open" 
               x-transition:enter="transition ease-out duration-200"
               x-transition:enter-start="opacity-0 transform scale-95"
               x-transition:enter-end="opacity-100 transform scale-100"
               x-transition:leave="transition ease-in duration-150"
               x-transition:leave-start="opacity-100 transform scale-100"
               x-transition:leave-end="opacity-0 transform scale-95"
               class="absolute z-30 mt-2 {% if LANGUAGE_CODE == 'ar' %}left-0{% else %}right-0{% endif %}">
            <form method="get" action="{% url 'heritage-filtered' %}"
                  class="bg-white rounded-lg shadow-lg border border-brand-navy/10 p-3 w-72">
              <div class="relative">
                <input x-ref="q" 
                       name="q" 
                       type="text" 
                       placeholder="{% trans 'Search heritage objects...' %}"
                       class="w-full border border-brand-navy/15 rounded-md pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold/60 focus:border-brand-gold" />
                <button type="submit" 
                        class="absolute right-1 top-1/2 -translate-y-1/2 p-1.5 text-brand-navy/60 hover:text-brand-gold transition">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                  </svg>
                </button>
              </div>
              <div class="mt-2 text-xs text-brand-navy/50">
                {% trans "Press Enter to search or Esc to close" %}
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Page body -->
  <main class="pb-16">
    {% block content %}{% endblock %}
  </main>

  <!-- Simple footer -->
  <footer class="bg-white border-t border-brand-navy/10">
    <div class="max-w-7xl mx-auto px-4 py-8 text-sm text-brand-navy/70 flex flex-col sm:flex-row items-center justify-between gap-3">
      <p>&copy; <span x-data x-text="new Date().getFullYear()"></span> {% trans "Turath3D" %}</p>
      <p class="opacity-80">{% trans "Inspired by the cultural landscapes of Saudi Arabia" %}</p>
    </div>
  </footer>

</body>
</html>